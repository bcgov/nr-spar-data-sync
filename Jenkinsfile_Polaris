@Library('polaris')
import ca.bc.gov.nrids.polaris.Podman
import ca.bc.gov.nrids.polaris.BrokerIntention
import ca.bc.gov.nrids.polaris.Vault

def podman

pipeline {
    agent none 
	environment {
		VTOKEN_COMMENT = 'Vault Token'
        VTOKEN = credentials('VTOKEN')
		OCTOKEN = credentials('OCToken')
		OCSERVER = credentials('OCServer')
		OCPROJECT = credentials('OCProject')
		OCPOD = credentials('OCPod')
		OCPORT = credentials('OCPort')
		OCPORTFOR = credentials('OCPortForward')
		TESTE_COMMMENT = 'Test Variable to check environment spread into podman instance'
		TESTE = '123'
		DPI_DEBUG_LEVEL=64
    }
    stages {
         stage('Checkout code') {
			agent {
                label Podman.AGENT_LABEL_APP
            }
		 	steps {
				checkout scm
			}
		 }
		 stage('Enable OC Port Forward') {
			agent {
                label Podman.AGENT_LABEL_APP
            } 
			steps {
				sh 'oc login --token=$OCTOKEN --server=$OCSERVER'
				sh 'oc project $OCPROJECT'
				sh 'oc port-forward $OCPOD $OCPORTFOR:$OCPORT'
			}
		 } 
		 
		 
		 stage('Run Compose') {
			agent {
                label Podman.AGENT_LABEL_APP
            }
		 	steps {
				sh 'pwd'
				sh 'dir'
				sh 'echo $TESTE'
				sh 'echo $VURL'
				sh 'echo $TESTE_MODE'
				sh 'echo $DSE_TEST_EXEC'
				sh 'podman build --env=vtoken=$VTOKEN --env=vurl=$VURL --env=test_mode=$DSE_TEST_EXEC --env=teste=$TESTE --platform=linux/amd64 --file=Dockerfile_Polaris .'
			}
		 }		 
    }
}

 